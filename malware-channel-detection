<#
.SYNOPSIS

Criado por Gabriel Peterossi Maricato e IA
Verifica possiveis canais que malware pode usar para enviar dados para terceiros.

.DESCRIPTION
Este script faz:
- Listagem de conexões de rede de saida (com portas suspeitas)
- Verificacao de servicos remotos ativos (RDP, WinRM, Remote Registry)
- Lista processos com conexões de rede
- Exibe portas comumente usadas para exfiltracao (HTTP, HTTPS, FTP, SMTP, DNS)
#>

Write-Host "####### [CRIADO POR GABRIEL PETEROSSI MARICATO E IA] #######" -ForegroundColor Yellow
Write-Host "[Verifica possiveis canais que malware pode usar para enviar dados para terceiros] `n" -ForegroundColor Yellow

# 1. Conexões de rede de saida
Write-Host "`n[1] Conexões de rede de saida:" -ForegroundColor Yellow
$connections = Get-NetTCPConnection -State Established | Where-Object { $_.LocalAddress -ne "127.0.0.1" }
if ($connections.Count -gt 0) {
    $connections | Select-Object LocalAddress, LocalPort, RemoteAddress, RemotePort, State, OwningProcess | Format-Table -AutoSize
} else {
    Write-Host "Nenhuma conexao de saida detectada." -ForegroundColor Green
}

# 2. Processos com conexões de rede
Write-Host "`n[2] Processos com conexões de rede:" -ForegroundColor Yellow
$processConnections = Get-NetTCPConnection -State Established | ForEach-Object {
    $proc = Get-Process -Id $_.OwningProcess -ErrorAction SilentlyContinue
    if ($proc) {
        [PSCustomObject]@{
            ProcessName   = $proc.ProcessName
            PID           = $_.OwningProcess
            LocalAddress  = $_.LocalAddress
            LocalPort     = $_.LocalPort
            RemoteAddress = $_.RemoteAddress
            RemotePort    = $_.RemotePort
        }
    }
}
if ($processConnections.Count -gt 0) {
    $processConnections | Format-Table -AutoSize
} else {
    Write-Host "Nenhum processo com conexao de rede detectado." -ForegroundColor Green
}

# 3. Verificacao de servicos remotos ativos
Write-Host "`n[3] Servicos remotos ativos:" -ForegroundColor Yellow
$remoteServices = @("TermService","WinRM","RemoteRegistry","UmRdpService","RemoteAccess","SessionEnv")
$serviceResults = @()

foreach ($svc in $remoteServices) {
    $s = Get-Service -Name $svc -ErrorAction SilentlyContinue
    if ($s) {
        $serviceResults += [PSCustomObject]@{
            ServiceName = $s.Name
            Status      = $s.Status
            StartupType = $s.StartType
        }
    }
}

if ($serviceResults.Count -gt 0) {
    $serviceResults | Format-Table -AutoSize
} else {
    Write-Host "Nenhum servico remoto ativo encontrado." -ForegroundColor Green
}

# 4. Verificacao de portas comumente usadas para exfiltracao
Write-Host "`n[4] Verificacao de portas suspeitas de exfiltracao (21, 25, 53, 80, 443, 3389, 5985, 5986):" -ForegroundColor Yellow
$suspiciousPorts = @(21,25,53,80,443,3389,5985,5986)
$portConnections = Get-NetTCPConnection -State Established | Where-Object { $suspiciousPorts -contains $_.RemotePort }

if ($portConnections.Count -gt 0) {
    $portConnections | Select-Object LocalAddress, LocalPort, RemoteAddress, RemotePort, State, OwningProcess | Format-Table -AutoSize
} else {
    Write-Host "Nenhuma conexao suspeita nas portas monitoradas." -ForegroundColor Green
}



Write-Host "`nVerificacao concluida." -ForegroundColor Cyan
